<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <link href="./config.yml" type="text/yaml" rel="cms-config-url">
  
  <!-- 1. 引入 Identity -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <!-- 状态显示 -->
  <div id="status" style="padding: 50px; text-align: center; font-family: sans-serif;">
    Loading...
  </div>

  <script>
    // 获取 hash
    const hash = window.location.hash;
    const isAuthFlow = hash.includes("token=");
    
    if (isAuthFlow) {
      // === 模式 A：身份验证模式 ===
      document.getElementById("status").innerText = "Detected Token. Processing Identity...";
      console.log("Auth flow detected. CMS script will NOT be loaded.");

      // Identity 插件会自动检测 URL hash 并尝试打开弹窗
      // 我们只需要监听结果
      
      if (window.netlifyIdentity) {
        // 确保 widget 已经打开
        window.netlifyIdentity.on("init", () => {
           // 强制打开弹窗（双重保险）
           window.netlifyIdentity.open(); 
        });

        window.netlifyIdentity.on("login", () => {
          document.getElementById("status").innerText = "Success! Redirecting...";
          window.location.href = "/admin/"; // 登录成功，跳回纯净的 admin 页
        });
      }

    } else {
      // === 模式 B：CMS 模式 ===
      document.getElementById("status").style.display = 'none';
      
      // 动态加载 CMS
      const script = document.createElement('script');
      script.src = "https://cdn.jsdelivr.net/npm/decap-cms@3.1.2/dist/decap-cms.min.js";
      document.body.appendChild(script);
      
      // 常规登录监听
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", user => {
          if (!user) {
            window.netlifyIdentity.on("login", () => { document.location.reload(); });
          }
        });
      }
    }
  </script>
</body>
</html>