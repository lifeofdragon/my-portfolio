<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  
  <!-- 1. 引用配置文件 -->
  <link href="./config.yml" type="text/yaml" rel="cms-config-url">

  <!-- 2. Identity Widget 必须放在 head 中优先加载 -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <!-- 3. 关键修复：保持这个 div 完全为空！不要在里面放任何 loading 动画 -->
  <!-- 之前的 removeChild 错误就是因为这里面有东西导致的 -->
  <div id="nc-root"></div>

  <!-- 4. 引入 CMS 脚本 -->
  <script src="https://cdn.jsdelivr.net/npm/decap-cms@3.1.2/dist/decap-cms.min.js"></script>
  
  <!-- 5. 注册监听器：解决注册/登录后的跳转问题 -->
  <script>
    // 确保 Netlify Identity 加载完成
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        // 如果用户没登录（比如刚从邮件跳过来，还没设置密码）
        if (!user) {
          // 监听“登录”事件（包括注册完成后的自动登录）
          window.netlifyIdentity.on("login", () => {
            // 强制刷新页面，让 CMS 重新初始化并进入后台
            document.location.reload();
          });
        }
      });
    }
  </script>
</body>
</html>